---
title: "Understanding the influence of transportation infrastrucure on Urban Heat in Phoenix, Arizona"
author: "C.G. Hoehne"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}

# default to knitr option of code printing
knitr::opts_chunk$set(echo = TRUE)

# load fonts for use figures
#extrafont::loadfonts(device = "win") 

# list of all dependant packages
list.of.packages <- c("tidyverse",
                      "data.table", 
                      "lubridate",
                      "weathermetrics",
                      "rgdal",
                      "rgeos",
                      "raster",
                      "tmap",
                      "maptools",
                      "xtable",
                      "knitr",
                      "tinytex",
                      "here")

# install missing packages
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# install TinyTex (for creating PDFs from rmarkdown) if it is not installed.
# NOTE YOU NEED TO RESTART R STUDIO AFTER INSTALL
#tinytex::install_tinytex(force = FALSE)

# load packages
invisible(lapply(list.of.packages, library, character.only = TRUE)) # invisible() just hides printing stuff in console

# store loaded packages and thier version in a data.frame
package.info <- data.frame("Package" = list.of.packages, "Version" = unlist(lapply(list.of.packages, function (x) as.character(packageVersion(x)))))

# load windows fonts and store as string
windowsFonts(Century=windowsFont("TT Century Gothic"))
windowsFonts(Times=windowsFont("TT Times New Roman"))
my.font <- "Century"
#my.font <- "Times"

```

## Data Sources

### Weather Data
- National Centers for Environmental Information (NCEI): https://gis.ncdc.noaa.gov/maps/ncei/cdo/hourly
- The Arizona Meteorological Network (AZMET): https://cals.arizona.edu/azmet/az-data.htm
- Maricopa County Flood Control District (MCFCD): https://www.maricopa.gov/3769/Weather-Sensor-Data

### Parking Data
- Forthcoming publication by Hoehne et al, info here: http://transportationlca.org/phoenixparking/

### Road Network Data
- OpenStreetMap (© OpenStreetMap contributors)
- Arizona Department of Transportation (ADOT)

### Traffic Data
- Calibrated Maricopa Association of Governments (MAG) travel demand and parcel data via modifed version of SUMO (Simulation of Urban MObility) using OpenStreetMap street network data


```{r data import, include = FALSE}

## import weather, roadway, traffic & parking data

#all.stations <- readRDS(here("data/outputs/all-station-data.rds")) # all station data (spatial points w/ metadata)
#uza.roads <- readRDS(here("data/outputs/osm-dissolved.rds")) # cleaned/clipped/buffered/dissoved UZA OSM data 
uza.stations <- readRDS(here("data/outputs/uza-station-data.rds")) # uza station data (spatial points w/ metadata)
w.data <- readRDS(here("data/outputs/2017-other-weather-data.rds")) # cleaned weather data for all stations
stations.buffered <- readRDS(here("data/outputs/station-buffers-final.rds")) # buffered station data w/ roadway & parking area
uza.weather <- w.data[station.name %in% uza.stations$station.name] # filter weather data to uza stations

# import cleaned traffic data
traffic <- fread(here("data/icarus_osm_traffic.csv"))

## import other various shapefiles for plotting
city.labels <- shapefile(here("data/shapefiles/other/phx_metro_labels.shp")) # city labels (pre-cropped to UZA)
uza.border <- shapefile(here("data/shapefiles/boundaries/maricopa_county_uza.shp")) # UZA 
cnty.border <- shapefile(here("data/shapefiles/boundaries/maricopa_county.shp")) # county 
highways <- shapefile(here("data/shapefiles/other/phx_metro_hways.shp")) # 2017 highways (pre-cropped to UZA)

```


```{r analysis, include = FALSE}

## First Pass Linear Regression Analysis
# test summer max temps vs parking/roadway percent

# store current radii buffer distances as vector for refrence
# BEST SO FAR IS ~100 >= R >= ~200 ft
radii.buffers <- c(100,150,175,200,250,350)

# create list of data from stations, filter uza.weather to relavent vars, then combine in list of DTs
all.data <- lapply(1:length(stations.buffered), function(x) as.data.table(stations.buffered[[x]]@data))
w <- uza.weather[, .(source,station.name,date.time.round,heat.f,temp.f,month,week,day,wday,hour)]
all.data <- lapply(1:length(all.data), function(x) w[all.data[[x]], on = .(station.name,source), nomatch = 0])
#for(y in 1:length(all.data)){all.data[[y]]$pave.prct <- all.data[[y]]$park.prct + all.data[[y]]$road.prct}
#saveRDS(all.data, here("data/outputs/all-merged-data.rds")) # save 

# create list of aggregated data frames for each buffer with max yearly temps by station
max.temp.agg <- list()
for(y in 1:length(all.data)){
  max.temp.agg[[y]] <- all.data[[y]][, .(max.temp = max(temp.f, na.rm = T), max.heat = max(heat.f, na.rm = T), road.prct = mean(road.prct, na.rm = T), park.prct = mean(park.prct, na.rm = T), pave.prct = mean(pave.prct, na.rm = T)), by = .(station.name)] # aggregate
  max.temp.agg[[y]]$max.temp <- ifelse(!is.finite(max.temp.agg[[y]]$max.temp), NA, max.temp.agg[[y]]$max.temp) # set inf values to NA
  max.temp.agg[[y]]$max.heat <- ifelse(!is.finite(max.temp.agg[[y]]$max.heat), NA, max.temp.agg[[y]]$max.heat) # set inf values to NA
  max.temp.agg[[y]] <- max.temp.agg[[y]][pave.prct > 0 & pave.prct <= 1] # remove extraneous   & 
  }

# create empty lists to store linear regression model/data/plots, iterate through, summarize, and plot
models <- list() # list of model objects
models.dt <- list() # list of data.tables of output data from models
models.pl <- list() # list of model plots

# linear model of 2017 max heat index by non iButton stations by pavement fraction
for(a in 1:length(max.temp.agg)){
  models[[a]] <- lm(max.temp.agg[[a]]$max.heat ~ max.temp.agg[[a]]$pave.prct)
  models.dt[[a]] <- as.data.table(data.frame(fit = signif(models[[a]]$fitted.values,6), x = signif(models[[a]]$model[,2],6), y = signif(models[[a]]$model[,1],6)))
  conf.i <- as.data.table(predict(models[[a]], interval="confidence", level = 0.95))
  conf.i[, `:=`(lwr = signif(lwr,6), upr = signif(upr,6), fit.f = as.factor(signif(fit,6)))][,fit := NULL]
  models.dt[[a]] <- merge(models.dt[[a]][,fit.f := as.factor(fit)], unique(conf.i), by = "fit.f", all.x = T)[,fit.f := NULL]
  
  # plots
  models.pl[[a]] <- (ggplot()
          + geom_segment(aes(x = 0, y = 100, xend = 1, yend = 100))   # x border (x,y) (xend,yend)
          + geom_segment(aes(x = 0, y = 100, xend = 0, yend = 135))  # y border (x,y) (xend,yend)
          + geom_ribbon(aes(ymin = lwr, ymax = upr, x = x), fill = "grey30", alpha = 0.2, data = models.dt[[a]])
          + geom_line(aes(y = fit, x = x), data = models.dt[[a]], colour = "red")
          + geom_point(aes(y = y, x = x), data = models.dt[[a]])
          + scale_x_continuous(expand = c(0,0))
          + scale_y_continuous(expand = c(0,0))
          + labs(x = paste0("Fractional Surrounding Area of Road & Parking Pavement (r=",radii.buffers[[a]],"ft)"), y = "2017 Max Observed Heat Index")
          + geom_text(aes(x = 0.75, y = 108), label = paste("R^2 ==",signif(summary(models[[a]])$r.squared, 2)), parse = T, family = my.font)
          + geom_text(aes(x = 0.75, y = 105), label = paste("p ==",signif(anova(models[[a]])$'Pr(>F)'[1], 2)), parse = T, family = my.font)
          + geom_text(aes(x = 0.75, y = 102), label = paste("n ==",nrow(models.dt[[a]])), parse = T, family = my.font)
          + theme_minimal()
          + theme(text = element_text(family = my.font, size = 12),
                  plot.margin = margin(t = 10, r = 20, b = 10, l = 10, unit = "pt"))
          )
  
  # save plots as png
  ggsave(paste0("max-temp-by-pavement-regression-r",radii.buffers[[a]],"ft.png"), models.pl[[a]], device = "png", path = here("figures"), scale = 1, width = 6.5, height = 5, dpi = 300, units = "in")
}


```

## Plots

Here are the working plots:

```{r data plots, echo = FALSE}

#-#-#-#-#-#-#-#
# Data Plots #
#-#-#-#-#-#-#

# set knitr chunk options to put spaces between plots
opts_chunk$set(fig.ncol = 3, fig.showtext = T, fig.sep = c('\\newline','\\newline','\\newline')) # only workds for LaTex output

# store palette for plotting stations
my.palette <- c("#0C120C","#640D14","#C20114","#6D7275")

# plot all station points with UZA, highways, & city labels for context.
stations.plot <-   
  tm_shape(uza.border) + tm_borders(lwd = 0.8, lty = "solid", col = "grey40", alpha = 0.7) + tm_fill(col = "grey90") + # urbanized area (UZA) border & fill
  tm_shape(all.stations, bbox = all.stations) + tm_dots(col = "source", border.col = NULL, palette = my.palette, size = 0.3, alpha = 0.8, title = "Data Source") + # stations
  tm_shape(cnty.border) + tm_borders(lwd = 0.8, lty = "solid", col = "grey20", alpha = 0.7) + # county border
  tm_scale_bar(position = c(0.4,0.0), breaks = c(0,5,10,15,20), size = 0.90, color.light = "grey85") + # scalebar
  tm_compass(north = 0, type = "4star", size = 2, show.labels = 1, position = c(0.9,0.85)) + # compass
  tm_shape(highways) + tm_lines(lwd = 1.1, col = "grey40") + # highways
  tm_shape(city.labels) + tm_text("name", size = 0.7, fontfamily = my.font,  fontface = "bold.italic", just = "center") + # city labels
  tm_layout(fontfamily = my.font, fontface = "italic", bg.color = "grey95", title.size = 1.5, legend.title.size = 1.20, # theme & formatting
            legend.text.size = 0.7, title = "", title.position = c(0.2,0.94),
            legend.position = c(0.1,0.45), outer.margins = c(0,0,0,0), asp = 0)

tmap_save(stations.plot, filename = here("figures/stations-w-ibut.png")) # option to save
stations.plot # plot in report

##
# calculate range of temps and mean temp for urbanized stations
##

# if time is within 15 min of hour, round to hour, otherwise drop, then
# aggregate to the min, mean, max temp at each unique timestep for all stations
uza.weather <- uza.weather[abs(difftime(date.time, date.time.round, units = "min")) < 15]
uza.weather.agg <- uza.weather[, .(min.temp.f = min(temp.f, na.rm = T),
                             med.temp.f = median(temp.f, na.rm = T),
                             max.temp.f = max(temp.f, na.rm = T)), by = .(date.time.round)]

# hourly temp min/mean/max by 2017 month aggregate across all stations
uza.weather.month.agg <- uza.weather[, .(min.temp.f = min(temp.f, na.rm = T),
                                   med.temp.f = median(temp.f, na.rm = T),
                                   max.temp.f = max(temp.f, na.rm = T)), by = .(hour,month)]

# plot hourly temp.f range by month for 2017 for all stations
# Plot historical tempeature plots of metro regions
month.x.hour.p <- ggplot(uza.weather.month.agg, aes(x = hour, y = med.temp.f , group = month)) +
  geom_ribbon(aes(ymin = min.temp.f, ymax = max.temp.f),  fill = "grey50", alpha = 0.5) +
  geom_line(size = 1.2) +
  geom_segment(aes(x = 0, y = 25, xend = 23, yend = 25)) +
  geom_segment(aes(x = 0, y = 25, xend = 0, yend = 135)) +
  facet_wrap(~ month , scales = "fixed") +
  labs(title = "Hourly Temperature Ranges by month for Phoenix UZA, 2017", x = "Hour", y = "Temperature (deg F)") +
  scale_x_continuous(limits = c(0,23), breaks = c(0,6,12,18), expand = c(0,0)) +
  scale_y_continuous(limits = c(25,135), breaks = c(25,50,75,100,125), expand = c(0,0)) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", family = my.font, size = 12, colour = "black", hjust = 1),
        strip.text = element_text(family = my.font, size = 11, colour = "black"),
        axis.title = element_text(face = "bold", family = my.font, size = 12, colour = "black"),
        axis.text = element_text(family = my.font, size = 10, colour = "black"),
        axis.text.x = element_text(hjust = 0.25) # for some reason the text isn't defaulted to centered on the ticks
  )

month.x.hour.p
ggsave("phx-uza-hrly-by-month-temp.png", month.x.hour.p, device = "png", path = here("figures"), scale = 1, width = 6.5, height = 8, dpi = 300, units = "in")

# plot hourly temp.f range for summer months for 2017 for all stations
uza.weather.sum.month.agg <- uza.weather[, .(min.temp.f = min(temp.f, na.rm = T),
                                   med.temp.f = median(temp.f, na.rm = T),
                                   max.temp.f = max(temp.f, na.rm = T)), by = .(hour,month,source)]
uza.weather.sum.month.agg <- uza.weather.sum.month.agg[month %in% c("Jun","Jul","Aug")]

sum.month.x.hour.p <- ggplot(uza.weather.sum.month.agg, aes(x = hour, y = med.temp.f , group = month)) +
  geom_ribbon(aes(ymin = min.temp.f, ymax = max.temp.f),  fill = "grey50", alpha = 0.5) +
  geom_line(size = 1.2) +
  geom_segment(aes(x = 0, y = 25, xend = 23, yend = 25)) +
  geom_segment(aes(x = 0, y = 25, xend = 0, yend = 135)) +
  facet_wrap(month ~ source, scales = "fixed") +
  labs(title = "Hourly Summer Temperatures Ranges for Phoenix UZA by Data Source, 2017", x = "Hour", y = "Temperature (deg F)") +
  scale_x_continuous(limits = c(0,23), breaks = c(0,6,12,18), expand = c(0,0)) +
  scale_y_continuous(limits = c(25,135), breaks = c(25,50,75,100,125), expand = c(0,0)) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", family = my.font, size = 12, colour = "black", hjust = 1),
        strip.text = element_text(family = my.font, size = 11, colour = "black"),
        axis.title = element_text(face = "bold", family = my.font, size = 12, colour = "black"),
        axis.text = element_text(family = my.font, size = 10, colour = "black"),
        axis.text.x = element_text(hjust = 0.25) # for some reason the text isn't defaulted to centered on the ticks
  
  )

sum.month.x.hour.p
ggsave("phx-uza-hrly-summer-temp.png", sum.month.x.hour.p, device = "png", path = here("figures"), scale = 1, width = 6.5, height = 8, dpi = 300, units = "in")

# create summer data aggreate by station for GIF
uza.weather.summer.station.agg <- uza.weather[month %in% c("Jun","Jul","Aug"), .(min.temp.f = min(temp.f, na.rm = T),
                                   mean.temp.f = mean(temp.f, na.rm = T),
                                   max.temp.f = max(temp.f, na.rm = T)), by = .(hour,station.name)]

```



This document was compiled using R `r getRversion()`, R Markdown, and the following packages:  

```{r appendix, echo = FALSE, results = 'asis'}

# hide xtable global comment option
options(xtable.comment = FALSE)

# output table of packages used with packages listed in alphabetical order
print(xtable(package.info[order(package.info$Package),], row.names = NULL), include.rownames=FALSE)

```





